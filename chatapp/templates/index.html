<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Chat App (Polling)</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        #chat-box {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        #message-input {
            width: 80%;
        }
    </style>
</head>

<body>
    <h2>ðŸ’¬ Chat Room (Polling)</h2>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”...">
    <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>


    <script>
        const token = localStorage.getItem('access');
        if (!token) {
            const username = prompt('Username ìž…ë ¥:');
            const password = prompt('Password ìž…ë ¥:');
            fetch('/api/token/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
                .then(res => res.json())
                .then(data => {
                    localStorage.setItem('access', data.access);
                    location.reload();
                });
        }

        function loadMessages() {
            fetch('/chat/poll/')  // í—¤ë” ì œê±°
                .then(res => res.json())
                .then(data => {
                    if (!Array.isArray(data)) return; // ì—ëŸ¬ ê°ì²´ë©´ ë¬´ì‹œ
                    const box = document.getElementById('chat-box');
                    box.innerHTML = data.map(m => `<p><b>${m.username}</b>: ${m.text}</p>`).join('');
                })
                .catch(err => console.error(err));
        }


        function sendMessage() {
            const text = document.getElementById('message-input').value;
            const username = prompt("ì‚¬ìš©ìž ì´ë¦„ ìž…ë ¥:", "ìµëª…");

            fetch('/chat/send/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },  // Authorization ì œê±°
                body: JSON.stringify({ text, username })
            })
                .then(() => {
                    document.getElementById('message-input').value = '';
                    loadMessages();
                })
                .catch(err => console.error(err));
        }


        setInterval(loadMessages, 3000);
        loadMessages();
    </script>
</body>

</html>